{% csrf_token %}

<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.5/jquery.min.js"></script>
<script type="text/javascript">

  function check_update_is_set(){
    // Actually we can use extraction interval (in days) without a loop, to test
    if (document.getElementById('baw_update_rate').value == "00:00")
      alert('Without an update rate, you will only extract one period of time')
    if (document.getElementById('baw_modified_after_date').value == "")
      alert('Modified after date is required before setting the extraction interval')
  }

  function stopExtraction(jobid){
    // call a python function to set the JOB.exit value to 1
    // only works if there is a loop to catch the value
    execute_python('stopextraction/'+jobid)
  }

  function execute_python(url, data) {
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    fetch(url, { method: "POST", headers: { 'X-CSRFToken': csrftoken }, body: JSON.stringify(data) });
  }

</script>

<!DOCTYPE html>

<html lang="en-US">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Business Automation Worflow - Process Mining Accelerator</title>
  <link href='https://fonts.googleapis.com/css?family=IBM Plex Sans' rel='stylesheet'>
  <style>
    body {
      font-family: 'IBM Plex Sans';
      font-size: 14px;
    }

    .bx--form__helper-text {
      font-size: 12px;
    }

    .btn_mod {
      border: none;
      background-color: inherit;
      padding: 14px 28px;
      font-size: 16px;
      cursor: pointer;
      display: inline-block;
    }

    .btn:hover {
      background: #eee;
    }

    .black {
      color: rgb(3, 3, 3);
    }

    .blue {
      color: rgb(13, 93, 173);
    }
    
/*
 CSS for the main interaction
*/
.accordion > input[type="checkbox"] {
  position: absolute;
  left: -100vw;
}

.accordion .content {
  overflow-y: hidden;
  height: 0;
  transition: height 0.3s ease;
}

.accordion > input[type="checkbox"]:checked ~ .content {
  height: auto;
  overflow: visible;
}

.accordion label {
  display: block;
}

/*
 Styling
*/

.accordion {
  margin-bottom: 1em;
}

.accordion > input[type="checkbox"]:checked ~ .content {
  padding: 15px;
  border: 1px solid #e8e8e8;
  border-top: 0;
}

.accordion .handle {
  margin: 0;
  font-size: 1.125em;
  line-height: 1.2em;
}

.accordion label {
  color: #333;
  cursor: pointer;
  font-weight: normsmalal;
  padding: 15px;
  background: #e8e8e8;
}

.accordion label:hover,
.accordion label:focus {
  background: #d8d8d8;
}

.accordion .handle label:before {
  font-family: 'fontawesome';
  content: "\f054";
  display: inline-block;
  margin-right: 10px;
  font-size: .58em;
  line-height: 1.556em;
  vertical-align: middle;
}

.accordion > input[type="checkbox"]:checked ~ .handle label:before {
  content: "\f078";
}



  </style>
</head>
{% csrf_token %}
<h2 style='font-size:24px' align="left">Start Job: {{ config.JOB.job_name }}</h2>
<hr> 

<form action="startextraction/{{ mybawjob.id }}" method="post">
  {% csrf_token %}

<table style="width:950px">
  <TR>
    <TD style="width:50px"></TD>
    <TD style="width:200px"></TD>
    <TD style="width:300px"></TD>
    <TD style="width:400px"></TD>
  </TR>  
  <TD></TD>
  <TD>Loop update rate</TD>
  <TD>
    <input type="time" step=1 id="baw_update_rate" name="baw_update_rate" size="40" value="{{ baw_update_rate }}">
    </TD>
    <TD><div style="color:#797676" class="bx--form__helper-text"><i>ex: Loops every 15 minutes. 0 means no loop</i></div></TD>
  </TD>
  <TR>
    <TD></TD>
    <TD>Modified after</TD>
    <TD>
      <input type="datetime-local" step=1 id="baw_modified_after" name="baw_modified_after" size="40" value="{{ baw_modified_after }}">
    </TD>
    <TD>
      <div style="color:#797676" class="bx--form__helper-text"><i>Retrieve instances modified after this date</i>
      </div>
    </TD>
  </TR>
  <TR>
    <TD></TD>
    <TD>Modified before</TD>
    <TD>
      <input type="datetime-local" step=1 id="baw_modified_before" name="baw_modified_before" size="40" value="{{ baw_modified_before }}">
    </TD>
    <TD><div style="color:#797676" class="bx--form__helper-text"><i>Retrieve instances modified before this date</i>
      </div>
    </TD>
  </TR>
  <TR>
    <TD></TD>
    <TD>Extraction interval (days)</TD>
    <TD><input type="number" min=0 id="baw_extraction_interval" name="baw_extraction_interval" size="2" value="{{ config.BAW.extraction_interval }}" onchange="check_after_is_set()"></TD>
    <TD><div style="color:#797676" class="bx--form__helper-text"><i>ex: extract per interval of 10 days. Modified after date is required</i></div></TD>
  </TR>
  <TR>
    <TD></TD>
    <TD># of threads</TD>
    <TD><input type="number" min=1 id="baw_thread_count" name="baw_thread_count" size="40" value="{{ config.BAW.thread_count }}"></TD>
    <TD><div style="color:#797676" class="bx--form__helper-text"><i>Number of threads for the extraction</i></div></TD>
  </TR>
  <TR>
    <TD></TD>
    <TD># instance limit</TD>
    <TD><input type="number" min=-1 vid="baw_instance_limit" name="baw_instance_limit" size="40" value="{{ config.BAW.instance_limit }}"></TD>
    <TD><div style="color:#797676" class="bx--form__helper-text"><i>Use to experiment the job or to determine performance. -1: unlimited</i></div></TD>
  </TR>
  <TR>
    <TD></TD>
    <TD>Create a CSV at each loop </TD>
    <TD>
        <input type="checkbox" id="baw_csv_at_each_loop" name="baw_csv_at_each_loop" {{ baw_csv_at_each_loop }}>
    </TD>
    <TD>
        <div style="color:#797676" class="bx--form__helper-text"><i>A CSV is generated at each loop. Otherwise only when +500k events are extracted</i>
        </div>
    </TD>
</TR>
  </table>
  <hr>
  <table style="width:950px" >
    <TR>
      <TD style="width:50px"></TD>
      <TD style="width:200px"></TD>
      <TD style="width:300px"></TD>
      <TD style="width:400px"></TD>
    </TR>
      <TR> </TR>
  <TR> </TR>
  <TR>
    <TD></TD>
    <TD></TD>
    <TD><input type="submit" value="Start">
      <input type="button" value="Stop" onclick="stopExtraction('{{ mybawjob.id }}')"></TD>
  </TR>
</table>
<hr>
<table style="width:950px">
  <TR>
    <TD style="width:50px"></TD>
    <TD style="width:900px"></TD>
  </TR>
  <TR>
    <TD></TD>
    <TD style="font-size:14px">
      <div style="color:#626060">
        <p>
          The parameters below are automatically updated during the extraction to keep track of what were the last
          extraction dates.
        <ul>
          <li>They are used when extracting historical data with a extraction interval (ex every 15 min extract 10 days
            of data)</li>
          <li>They are also used when monitoring new events, to extract only new data.</li>
          <li>Clear these dates if you want to 'forget' what was done during the last extraction. (you can ignore the
            time)
          </li>
        </ul>
      
        </p>
      </div>
    </TD>
  </TR>
</table>
<table style="width:950px" >
  <TR>
    <TD style="width:50px"></TD>
    <TD style="width:200px"></TD>
    <TD style="width:300px"></TD>
    <TD style="width:400px"></TD>
  </TR> 
  <TR style="font-size:12px">
    <TD></TD>
    <TD>Last extraction: Modified after</TD>
    <TD>
      <input type="datetime-local" step=1 id="baw_last_after" name="baw_last_after" size="40" value="{{ baw_last_after }}">
    </TD>
  </TR>
  <TR style="font-size:12px">
    <TD></TD>
    <TD>Last extraction: Modified before</TD>
    <TD>
      <input type="datetime-local" step=1 id="baw_last_before" name="baw_last_before" size="40" value="{{ baw_last_before }}">
    </TD>
  </TR>
</form>
</table>
<hr>
<table style="width:950px" >
  <TR>
    <TD style="width:50px"></TD>
    <TD ></TD>
  </TR>
  <TR >
    <TD></TD>
    <TD>Job summary
    </TD>
  </TR>
  <TR style="font-size:12px">
    <TD></TD>
    <TD>BAW URL: {{ config.BAW.root_url }}</TD>
  </TR>
  <TR style="font-size:12px">
    <TD></TD>
    <TD>BAW Process Acronym : {{ config.BAW.project }}</TD>
  </TR>
  <TR style="font-size:12px">
    <TD></TD>
    <TD>BAW Process Name : {{ config.BAW.process_name }}</TD>
  </TR>
  <TR style="font-size:12px">
    <TD></TD>
    <TD>IPM URL : {{ config.IPM.url}}</TD>
  </TR>
  <TR style="font-size:12px">
    <TD></TD>
    <TD>IPM Process : {{ config.IPM.project_key }}</TD>
  </TR>

  </TR>
  </table>
<hr>
  <section class="accordion">
    <input type="checkbox" name="collapse" id="handle1">
    <h2 class="handle">
      <label for="handle1">
      Instruction details (open for more)
      </label>
    </h2>
    <div class="content">
      <p> 
        <ul>
          <li>Start button runs the extraction in a subprocess.</li>
          <li>Stop button terminates the extraction if there is an extraction loop (update rate). Otherwise, the extraction
            can only be stopped by stopping the server (CTRL C)</li>
          <li>Modified after and modified before: extract bpd instances that changed during this period</li>
          <li>Extraction interval requires a modified after date. The extraction starts from this date until the # of days
            requested</li>
          <li>Extraction interval combined with loop update enables extracting a period of time and shifting this period for
            the next loop. Useful to fetch lots of data without impacting too much the BAW server</li>
          <li># of threads can be increased to allow for some parallelism. Caution: more thread is faster, but more demanding on BAW</li>
          <li>This page will automatically move to the completed job page when the extraction is completed (that can be
            long)</li>
        </ul>
      </p>  
    </div>
  </section>



</html>
